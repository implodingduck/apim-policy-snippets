<policies>
    <inbound>
        <base />
        <llm-content-safety backend-id="contentsafety" shield-prompt="true">
            <categories output-type="EightSeverityLevels">
                <category name="Hate" threshold="4" />
                <category name="Violence" threshold="4" />
            </categories>
        </llm-content-safety>
        <authentication-managed-identity resource="https://cognitiveservices.azure.com" output-token-variable-name="msi-access-token" ignore-error="false" />
        <set-header name="Authorization" exists-action="override">
            <value>@("Bearer " + (string)context.Variables["msi-access-token"])</value>
        </set-header>
        <set-backend-service backend-id="@( context.Request.MatchedParameters["deployment-id"].Replace(".","-") + "-pool" )" />
        <azure-openai-emit-token-metric namespace="AzureOpenAI">
            <dimension name="Subscriber" value="@(context.Subscription.Name)" />
            <dimension name="Model" value="@(context.Request.MatchedParameters["deployment-id"])" />
        </azure-openai-emit-token-metric>
        <set-variable name="counter" value="@{return 0;}" />
        <set-variable name="statuschain" value="" />
    </inbound>
    <backend>
        <retry condition="@(context.Response.StatusCode >= 429)" count="2" interval="2" max-interval="45" delta="1" first-fast-retry="false">
            <forward-request http-version="1" buffer-request-body="true" />
            <set-variable name="counter" value="@{return (context.Variables.GetValueOrDefault<int>("counter") + 1);}" />
            <set-variable name="statuschain" value="@{return (context.Variables.GetValueOrDefault<string>("statuschain") + "|||" + context.Response.StatusCode + " - " + context.Response.Headers.GetValueOrDefault("x-ms-region","missing"));}" />
        </retry>
    </backend>
    <outbound>
        <base />
        <set-header name="X-Counter" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<int>("counter") + "")</value>
        </set-header>
        <set-header name="X-Statuschain" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("statuschain") + "")</value>
        </set-header>
    </outbound>
    <on-error>
        <base />
        <choose>
            <when condition="@(context.LastError?.Source == "llm-content-safety")">
                <trace source="Terraform Managed Openai" severity="error">
                    <message>@((string)context.Request.Body?.As<string>(true))</message>
                </trace>
            </when>
            <otherwise />
        </choose>
    </on-error>
</policies>